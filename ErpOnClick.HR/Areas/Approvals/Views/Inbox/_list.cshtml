@using ErpOnClick.ErpMain.Models
@using ErpOnClick.ErpMain.Resources
@inject LocService SharedLocalizer

@{
    List<ApprovalRouteDetailViewModel> InboxList = Model.ApprovalRouteDetailViewModelList;
    string controllerName = null, areaName = null;
}
<style>
    .btnwidth {
        width: 75px;
    }
</style>
@Html.Partial("/Views/Shared/ApprovalLayout/_generalModalPartial.cshtml")
<div class="table-responsive pb-2 ">
    <div>
        <table id="dtList" class="table table-hover table-condensed " style="display:none">
            <thead class="text-sm">
                <tr>
                    <th> @SharedLocalizer.GetLocalizedHtmlString("Subject") </th>
                    <th> @SharedLocalizer.GetLocalizedHtmlString("Record Name") </th>
                    <th>@SharedLocalizer.GetLocalizedHtmlString("Requested By")  </th>
                    <th>@SharedLocalizer.GetLocalizedHtmlString("Requested Date")  </th>

                    <th>@SharedLocalizer.GetLocalizedHtmlString("Approval")  </th>
                    <th>@SharedLocalizer.GetLocalizedHtmlString("Action Date")  </th>
                    <th>@SharedLocalizer.GetLocalizedHtmlString("Approval Status")  </th>
                    <th>@SharedLocalizer.GetLocalizedHtmlString("Actions")  </th>
                </tr>
            </thead>
            <tfoot style="display:table-row-group">
                <tr class="text-center">

                    <th> Subject </th>
                    <th> Record Name </th>
                    <th> Requested By </th>
                    <th> Requested Date </th>

                    <th> Approval </th>
                    <th> Action Date </th>

                    <th> Approval Status </th>

                    <th> Actions </th>


                </tr>
            </tfoot>
            <tbody>
                @foreach (var item in InboxList.OrderByDescending(x => x.Route.CreatedDate))
                {

                    <tr class="text-center">

                        <td align="left"> @item.Route.RecordNotes </td>
                        <td align="left"> @item.Route.RecordName </td>
                        <td align="left"> @item.RequestedBy </td>
                        <td>@(item.Route.CreatedDate != null ? Convert.ToDateTime(item.Route.CreatedDate).ToString("dd-MMM-yyyy") : "")</td>

                        <td align="left"> @item.ApprovarUser </td>
                        <td>@(item.Route.ActionDate != null ? Convert.ToDateTime(item.Route.ActionDate).ToString("dd-MMM-yyyy") : "Waiting for action")</td>

                        <td align="center">
                            @if (item.Status == "Rejected")
                            {
                                <label class="text-danger"><i class="fal fa-times mr-2"></i>Rejected</label>
                            }
                            else if (item.Status == "Approved")
                            {
                                <label class="text-success"><i class="fal fa-check mr-2"></i>Approved</label>
                            }
                            else
                            {
                                <label class="text-warning"><i class="fal fa-spinner fa-spin mr-2"></i>Pending</label>
                            }
                        </td>

                        <td class="text-center" width="40px">
                            @*<a href="javascript:void(0)" class="btn btn-sm " onclick="showDetail('@System.Text.Json.JsonSerializer.Serialize(item.Route)','@item.RequestedBy','@System.Text.Json.JsonSerializer.Serialize(item.ApproverUsersList)')" title="Edit"><i class="fal fa-search"></i></a>*@
                            <a href="javascript:void(0)" class="btn btn-sm " onclick="showDetail('@System.Text.Json.JsonSerializer.Serialize(item)')" title="Edit"><i class="fal fa-search"></i></a>
                            @if (!string.IsNullOrEmpty(item.ApprovalTasks.URL))
                            {
                                var urlArray = item.ApprovalTasks.URL.Split("/");

                                @*<input type="button" value="Open" onclick="window.open('@Url.Action("edit", urlArray[1] , new { Area = urlArray[0],id = item.Route.RecordId })')" />*@
                                <a href="javascript:void(0)" class="btn btn-sm " onclick="window.open('@Url.Action("edit", urlArray[1] , new { Area = urlArray[0],id = item.Route.RecordId,code = "101" })')" title="View Detail"><i class="fal fa-eye"></i></a>
                            }
                            else
                            {
                                <a href="javascript:void(0)" class="btn btn-sm " onclick="redirectToRequestEdit('@item.ApprovalTasks.URL','@item.ApprovalTasks.ApprovalTaskId')" title="View Detail"><i class="fal fa-eye"></i></a>
                            }

                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="TaskDetailModal" tabindex="-1" role="dialog" aria-labelledby="importdataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document" style="max-width:1024px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title pull-left">Request Detail </h5>
                <button type="button" class="close pull-right" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="clearfix"></div>
            </div>

            <div class="modal-body" style="font-family:Calibri" id="TaskDetailModalBody">

            </div>
        </div>
    </div>
</div>

<script>
    $(function () {

        _initDatatable('#dtList');
        $('#dtList').show();
    });
    var applicationName = getApplicationName();


    //function showDetail(LogDetail, requestedBy, approvalUsers) {
    function showDetail(taskDetail) {

        @*console.log('LogDetail : ' + JSON.stringify(LogDetail));
        console.log('requestedBy : ' + JSON.stringify(requestedBy));
        console.log('approvalUsers : ' + JSON.stringify(approvalUsers));
        var jsonData = JSON.parse(LogDetail);
        var approvalUsersJson = JSON.parse(approvalUsers);



        var displayDAta = "<form action='" + applicationName + "Approvals/Inbox/ChangeStatus'><input type='hidden' id='id' name='id' value='" + jsonData.RouteDetailId + "'> <div class='row'><h5>@SharedLocalizer.GetLocalizedHtmlString("Request Details")</h5><hr/><br/><div class='col-sm-12'><table id='dtList' class='table table-bordered'><thead><tr><th>@SharedLocalizer.GetLocalizedHtmlString("Subject")</th><th>@SharedLocalizer.GetLocalizedHtmlString("Record Name")</th><th>@SharedLocalizer.GetLocalizedHtmlString("Requested By")</th><th>@SharedLocalizer.GetLocalizedHtmlString("Requested Date")</th></tr></thead><tbody><tr><td>" + jsonData.RecordNotes + "</td ><td>" + jsonData.RecordName + "</td > <td>" + requestedBy + "</td><td>" + new Date(jsonData.CreatedDate).toDateString("yyyy-MM-dd") + "</td></tr></tbody></table></div><br/><hr/><h5>@SharedLocalizer.GetLocalizedHtmlString("Approvers")</h5><div class='col-sm-12' ><hr /><ul >";

        $.each(approvalUsersJson, function (key, value) {

            displayDAta += "<li class='box' style='font-weight:900;font-size:20px;letter-spacing:1px'>" + value.UserName + "   ";
            if (value.Status == "Pending") {
                displayDAta += "<label class='text-warning right pl-3'><i class='fal fa-spinner fa-spin mr-2'></i>" + value.Status + "</label></li>";
            }
            else if (value.Status == "Rejected") {
                displayDAta += "<label class='text-danger right pl-3'><i class='fal fa-times mr-2'></i>" + value.Status + "</label></li>";
            }
            else {
                displayDAta += "<label class='text-success right pl-3'><i class='fal fa-check mr-2'></i>" + value.Status + "</label></li>";
            }
        });

        if (jsonData.ApprovalStatus == "007002" || jsonData.ApprovalStatus == "007003") {
                    displayDAta += "</ul ></div ></form>"

        }
        else {

            displayDAta += "</ul ></div ><h5>@SharedLocalizer.GetLocalizedHtmlString("Submit Your Action")</h5><div class='col-sm-12'><hr /> <label>@SharedLocalizer.GetLocalizedHtmlString("Status")</label><select name='Status' class='form-control'><option value='007001'>Pending</option><option value='007002'>Approved</option><option value='007003'>Rejected</option></select><label>@SharedLocalizer.GetLocalizedHtmlString("Comments")</label><textarea id='APPROVER_NOTES' name='APPROVER_NOTES' class='form-control border-0' style='background-color: whitesmoke;width: 100%;' borderrows=6 placeholder = 'Enter your comments here ...' ></textarea > <div class='clearfix margin-5'></div><hr><button type='submit' class='btn btn-primary' style='width:inherit'><i class='fal fa-check'></i> @SharedLocalizer.GetLocalizedHtmlString("Submit")</button></div></div></form> "

        }

        $('#generalModal .modal-body').html(displayDAta);
        $('#generalModal').modal('show');
        $('#generalModal .modal-title').html('Request Detail');*@

        debugger;
        console.log(taskDetail);
        $.ajax({
            url: applicationName + 'Approvals/Inbox/RequestDetailPartialView',
            type: "post",
            data: { approvalRouteDetailViewModel: taskDetail },
            success: function (data) {
                //$('#divList').html('').html(data);
                //$('#generalModal .modal-body').html(data);
                //$('#generalModal').modal('show');
                //$('#generalModal .modal-title').html('Request Detail');
                $('#TaskDetailModalBody').html(data);
                $('#TaskDetailModal').modal('show');
            }
        })

        //$('#TaskDetailModal').modal('show');

    }
    function redirectToRequestEdit(requestURL,approvalTaskId) {
        debugger;
        if (requestURL == null || requestURL == '') {
            confirmAction('Confirm ?', 'URL not defined do you want to define now?', 'info', 'Yes', 'No').then(function (result) {
                if (result.value == true) {
                    window.location.href = '/Security/ApprovalTask/edit/' + approvalTaskId;
                }
            });
        }       


    }
    function setStatusVal(status) {
        var valueNotes = $("#APPROVER_NOTES").val();
        var id = $("#ROUTE_DETAIL_ID").val();

    }
    //

</script>